<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>3-3 ã€Œå¹´é½¡å•é¡Œã€å…¨å“¡ç«¶æŠ€æŒ‘æˆ°è³½</title>
<style>
/* 100% ä¿ç•™æ‚¨æä¾›çš„ç²¾ç¾ CSS æ¨£å¼ */
:root { --c-blue:#4dabf7; --c-bg:#e7f5ff; --c-text:#1971c2; --c-org:#ff922b; --c-org-bg:#fff4e6; --c-org-text:#d9480f; --c-alert:#e03131; }
body { margin: 0; padding: 0; background: var(--c-bg); font-family: 'Microsoft JhengHei', sans-serif; user-select: none; -webkit-user-select: none; }
#game-simplify { max-width:850px; margin:20px auto; padding:30px; border:5px solid #f1f3f5; border-radius:20px; text-align:center; background:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.08); transition:border-color 0.1s, box-shadow 0.1s; position:relative; overflow:hidden; }
.pg-title { font-size:2.5rem; color:#ff0000; margin-bottom:30px; font-weight:900; text-shadow:2px 2px 4px rgba(0,0,0,0.15); line-height: 1.3; }
.pg-input-group { display:flex; justify-content:center; gap:20px; margin-bottom:30px; }
.pg-input-wrap label { display:block; font-size:1.5rem; margin-bottom:5px; font-weight:bold; color:#666; }
.pg-input-wrap input { width:130px; font-size:2.2rem; text-align:center; padding:10px; border:3px solid #ddd; border-radius:12px; font-weight:bold; color:#333; }
.pg-btn-start, .pg-btn-restart, .pg-btn-review { border:none; padding:15px 40px; font-size:2rem; border-radius:15px; cursor:pointer; font-family:'Microsoft JhengHei'; font-weight:bold; margin:10px; }
.pg-btn-start, .pg-btn-restart { background:#5c7cfa; color:white; }
.pg-btn-review { background:#fcc419; color:#d9480f; }
.pg-header { display:flex; gap:15px; margin-bottom:20px; position:relative; }
.pg-info-card { flex:1; background:var(--c-bg); color:var(--c-text); padding:15px; border-radius:15px; font-weight:bold; border:2px solid var(--c-blue); }
.pg-info-card .label { display:block; font-size:1.2rem; opacity:0.8; }
.pg-info-card .value { font-size:3.5rem; line-height:1.1; }
#pg-combo-box { position:absolute; right:-20px; top:-15px; background:#ffec99; border:4px solid #e67700; border-radius:50%; width:100px; height:100px; display:flex; flex-direction:column; justify-content:center; align-items:center; transform:rotate(15deg); box-shadow:0 5px 15px rgba(230,119,0,0.4); z-index:10; }
.combo-hide { display:none!important; }
.combo-label { font-size:1.2rem; font-weight:bold; color:#e67700; margin-bottom:-5px; }
.combo-val { font-size:3.5rem; font-weight:900; color:#d9480f; text-shadow:1px 1px 0 #fff; }
.combo-pump { animation:pump 0.2s; }
#turkey-overlay { position:absolute; top:15px; left:15px; width:auto; height:auto; background:transparent; z-index:999; display:flex; pointer-events:none; }
.turkey-hide { display:none!important; }
.turkey-content { display:flex; align-items:center; gap:10px; background:rgba(255,236,153,0.98); border:3px solid #e67700; border-radius:40px; padding:8px 25px; box-shadow:0 8px 15px rgba(0,0,0,0.2); animation:popInCorner 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.turkey-icon { font-size:3rem; line-height:1; animation:wobble 1s infinite; }
.turkey-info { text-align:left; }
.turkey-text { font-size:1.8rem; font-weight:900; color:#e03131; line-height:1; margin-bottom:2px; }
.turkey-sub { font-size:1.1rem; color:#d9480f; font-weight:bold; }
.pg-question-area { background:var(--c-org-bg); border:4px solid var(--c-org); padding:25px; border-radius:20px; margin-bottom:20px; }
.pg-question-text { font-size:1.5rem; margin:0; color:var(--c-org-text); text-align:left; }
#pg-problem-text { font-size: 1.8rem; font-weight: bold; margin: 20px 0 30px; color: #333; line-height: 1.8; text-align: center; padding: 0 10px; min-height: 80px; display: block; }
.fraction { display: inline-block; vertical-align: middle; margin: 0 0.2rem; text-align: center; font-size: 0.9em; }
.fraction .top { display: block; border-bottom: 2px solid currentColor; padding: 0 2px; line-height: 1; }
.fraction .bottom { display: block; padding: 0 2px; line-height: 1; }
.pg-options-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
.pg-opt-btn { background:#fff; border:3px solid var(--c-blue); color:var(--c-text); font-size:1.4rem; padding:15px 5px; border-radius:15px; cursor:pointer; font-weight:bold; font-family:'Segoe UI', 'Microsoft JhengHei', sans-serif; display:flex; justify-content:center; align-items:center; min-height: 80px; line-height: 1.3; }
.pg-opt-btn:hover { background:#e7f5ff; }
.pg-correct { background:#40c057!important; color:#fff!important; border-color:#2b8a3e!important; }
.pg-wrong { background:#fa5252!important; color:#fff!important; border-color:#c92a2a!important; }
.pg-result-card { border:4px solid var(--c-blue); padding:30px 10px; border-radius:20px; background:#f8f9fa; margin-bottom:20px; }
#pg-final-student-id { font-size:4rem; font-weight:900; color:#333; margin-bottom:10px; border-bottom:2px dashed #ccc; padding-bottom:15px; display:inline-block; min-width:80%; }
#pg-final-score-num { font-size:8rem; font-weight:900; color:var(--c-alert); line-height:1; margin:10px 0 30px 0; }
/* å…¨å“¡æ’åå°ˆç”¨æ¨£å¼ */
#all-ranks { margin-top: 20px; text-align: left; background: #fff9db; border: 3px solid #fab005; border-radius: 15px; padding: 20px; display:none; }
.rank-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #ffe066; font-size: 1.3rem; font-weight: bold; }
.rank-top { background: #fff4e6; color: #d9480f; }
@keyframes pump { 0%{transform:scale(1) rotate(15deg)} 50%{transform:scale(1.2) rotate(15deg)} 100%{transform:scale(1) rotate(15deg)} }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-10px)} 75%{transform:translateX(10px)} }
@media(max-width:768px){ .pg-title{font-size:1.8rem} #pg-problem-text{font-size:1.3rem} .pg-opt-btn{font-size:1.1rem} .pg-options-grid{grid-template-columns:1fr} }
</style>

<div id="game-simplify">
  <div id="pg-login-view">
    <h1 class="pg-title">3-3 ã€Œå¹´é½¡å•é¡Œã€å…¨å“¡ç«¶æŠ€è³½</h1>
    <div class="pg-input-group">
      <div class="pg-input-wrap"><label>ç­ç´š</label><input type="tel" id="pg-class" placeholder="701" maxlength="3"></div>
      <div class="pg-input-wrap"><label>åº§è™Ÿ</label><input type="tel" id="pg-seat" placeholder="05" maxlength="2"></div>
    </div>
    <button class="pg-btn-start" onclick="GameSimp.start()">é–‹å§‹æŒ‘æˆ°</button>
  </div>

  <div id="pg-game-view" style="display:none;">
    <div class="pg-header">
      <div class="pg-info-card">å€’æ•¸<br><span class="value" id="pg-timer">60</span></div>
      <div class="pg-info-card">å¾—åˆ†<br><span class="value" id="pg-score">0</span></div>
      <div id="pg-combo-box" class="combo-hide">
        <div class="combo-label">é€£æ“Š</div><div class="combo-val" id="pg-combo-num">0</div>
      </div>
    </div>
    <div class="pg-question-area">
      <h2 class="pg-question-text">ä¾é¡Œæ„åˆ—å‡ºæ–¹ç¨‹å¼ï¼š</h2>
      <div id="pg-problem-text"></div>
      <div class="pg-options-grid" id="pg-options"></div>
    </div>
    <div id="turkey-overlay" class="turkey-hide">
      <div class="turkey-content"><div class="turkey-icon">ğŸ¦ƒ</div><div class="turkey-info"><div class="turkey-text">å˜‰ç¾©ç«é›!</div><div class="turkey-sub" id="turkey-msg"></div></div></div>
    </div>
  </div>

  <div id="pg-result-view" style="display:none;">
    <div class="pg-result-card">
      <h2 class="pg-result-title">æŒ‘æˆ°çµæœ</h2>
      <div id="pg-final-student-id"></div>
      <div id="pg-final-score-num">0</div>
      <p id="sync-status">ğŸ“¡ æ­£åœ¨åŒæ­¥å…¨ç­æ’å...</p>
      <div id="all-ranks"><h3>ğŸ† å…¨å“¡å³æ™‚è‹±é›„æ¦œ</h3><div id="rank-list"></div></div>
      <button class="pg-btn-restart" onclick="location.reload()">å†æˆ°ä¸€å ´</button>
    </div>
  </div>
</div>

<script>
// æ‚¨å°ˆå±¬çš„ Google Apps Script ç¶²å€
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxBPnJo1I_P6mKlJ0ALJ9J0HwcoYaYSOdFgkgZAtpQ26OQblc5irWpKLDD4JITJdYbe/exec";

var GameSimp = (function() {
  let score=0, time=60, timer=null, playing=false, ans="", combo=0, audioCtx=null;

  function initAudio(){ if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
  function speak(t){ window.speechSynthesis.cancel(); let u=new SpeechSynthesisUtterance(t); u.lang='zh-TW'; u.rate=1.4; window.speechSynthesis.speak(u); }
  
  // é‚„åŸæ‚¨æœ€æ»¿æ„çš„æ‰€æœ‰éŸ³æ•ˆé‚è¼¯
  function playDingDong() {
    if(!audioCtx) return; const n=audioCtx.currentTime; let o1=audioCtx.createOscillator(), g1=audioCtx.createGain();
    o1.type='sine'; o1.frequency.setValueAtTime(523.25, n); g1.gain.setValueAtTime(1.0, n); g1.gain.exponentialRampToValueAtTime(0.01, n+0.5);
    o1.connect(g1); g1.connect(audioCtx.destination); o1.start(); o1.stop(n+0.5);
    if(combo>=2){
      let o2=audioCtx.createOscillator(), g2=audioCtx.createGain();
      o2.type='sine'; o2.frequency.setValueAtTime(783.99+(combo*50), n+0.1); g2.gain.setValueAtTime(0.8, n+0.1); g2.gain.exponentialRampToValueAtTime(0.01, n+0.6);
      o2.connect(g2); g2.connect(audioCtx.destination); o2.start(n+0.1); o2.stop(n+0.6);
    }
  }
  function playTurkeySound() {
    if(!audioCtx) return; const n=audioCtx.currentTime; let o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='sawtooth'; o.frequency.setValueAtTime(200, n);
    for(let i=0; i<10; i++){ o.frequency.linearRampToValueAtTime(350, n+i*0.08); o.frequency.linearRampToValueAtTime(200, n+i*0.08+0.04); }
    g.gain.setValueAtTime(1.0, n); g.gain.exponentialRampToValueAtTime(0.01, n+0.8);
    o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(n+0.8);
  }
  function playTick(timeLeft) {
    if(!audioCtx) return; const n=audioCtx.currentTime; let o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='sine'; let f=(timeLeft<=10)?800+(10-timeLeft)*100:600; o.frequency.setValueAtTime(f, n);
    g.gain.setValueAtTime((timeLeft<=10?0.5:0.2), n); g.gain.exponentialRampToValueAtTime(0.01, n+0.1);
    o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(n+0.1);
  }
  function playWrong() { if(!audioCtx) return; let o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sawtooth'; o.frequency.value=150; g.gain.value=1.0; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.5); }

  function getFrac(t, b) { return `<span class="fraction"><span class="top">${t}</span><span class="bottom">${b}</span></span>`; }

  function generateQuestion() {
    const type = Math.floor(Math.random()*5);
    const r = [{b:"çˆ¶è¦ª",s:"å…’å­"},{b:"æ¯è¦ª",s:"å¥³å…’"},{b:"è€å¸«",s:"å­¸ç”Ÿ"}][Math.floor(Math.random()*3)];
    let qObj={};
    if(type==0){
      let d=Math.floor(Math.random()*15+20), s=Math.floor(Math.random()*30+50);
      qObj={q:`${r.b}æ¯”${r.s}å¤§ ${d} æ­²ï¼Œå…©äººå¹´é½¡å’Œç‚º ${s} æ­²ã€‚è‹¥${r.s}ä»Šå¹´ x æ­²ã€‚`, a:`x + (x + ${d}) = ${s}`, o:[`x + (x + ${d}) = ${s}`, `x + (x - ${d}) = ${s}`, `2x = ${s} + ${d}`, `x + x = ${s} - ${d}`]};
    } else if(type==1){
      let m=Math.floor(Math.random()*2+2), tt=Math.floor(Math.random()*30+40);
      qObj={q:`${r.b}çš„å¹´é½¡æ˜¯${r.s}çš„ ${m} å€ï¼Œå…©äººå¹´é½¡å’Œç‚º ${tt} æ­²ã€‚è‹¥${r.s}ä»Šå¹´ x æ­²ã€‚`, a:`x + ${m}x = ${tt}`, o:[`x + ${m}x = ${tt}`, `x + ${getFrac('x',m)} = ${tt}`, `${m}x - x = ${tt}`, `x + (x + ${m}) = ${tt}`]};
    } else {
      let y=Math.floor(Math.random()*5+3), mt=Math.floor(Math.random()*2+2), cur=Math.floor(Math.random()*10+30);
      qObj={q:`${r.b}ä»Šå¹´ ${cur} æ­²ï¼Œ${r.s}ä»Šå¹´ x æ­²ã€‚<span style='color:red;'>${y} å¹´å¾Œ</span>ï¼Œ${r.b}æ˜¯${r.s}çš„ ${mt} å€ã€‚`, a:`${cur} + ${y} = ${mt}(x + ${y})`, o:[`${cur} + ${y} = ${mt}(x + ${y})`, `${cur} + ${y} = ${mt}x + ${y}`, `${cur} = ${mt}(x + ${y})`, `(${cur} + ${y}) * ${mt} = x + ${y}`]};
    }
    ans = qObj.a; document.getElementById('pg-problem-text').innerHTML = qObj.q;
    let div = document.getElementById('pg-options'); div.innerHTML="";
    qObj.o.sort(()=>Math.random()-0.5).forEach(o=>{
      let b=document.createElement('button'); b.className='pg-opt-btn'; b.innerHTML=o; b.onclick=()=>check(o,b); div.appendChild(b);
    });
  }

  function check(v, btn) {
    if(!playing) return;
    document.querySelectorAll('.pg-opt-btn').forEach(b=>b.disabled=true);
    if(v === ans){
      combo++; score+=10; btn.classList.add('pg-correct'); playDingDong();
      if(combo>0 && combo%3===0){
        let el=document.getElementById('turkey-overlay'); document.getElementById('turkey-msg').innerText=`é€£å° ${combo} é¡Œå¤ªå¼·å•¦`;
        el.classList.remove('turkey-hide'); playTurkeySound(); setTimeout(()=>el.classList.add('turkey-hide'),1500);
      }
    } else {
      combo=0; score-=10; btn.classList.add('pg-wrong'); playWrong();
      document.querySelectorAll('.pg-opt-btn').forEach(b=>{if(b.innerHTML===ans) b.classList.add('pg-correct');});
      let gv=document.getElementById('game-simplify'); gv.classList.remove('wrong-shake'); void gv.offsetWidth; gv.classList.add('wrong-shake');
    }
    document.getElementById('pg-score').innerText=score;
    document.getElementById('pg-combo-num').innerText=combo;
    document.getElementById('pg-combo-box').className=combo>=2?'combo-pump':'combo-hide';
    setTimeout(generateQuestion, 1200);
  }

  function sendData() {
    let payload = { classId: document.getElementById('pg-class').value, seatId: document.getElementById('pg-seat').value, score: score };
    fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) })
    .then(res => res.json()).then(data => {
      document.getElementById('sync-status').innerText = "âœ… å…¨å“¡æ’ååŒæ­¥å®Œæˆ";
      document.getElementById('all-ranks').style.display = "block";
      let list = document.getElementById('rank-list'); list.innerHTML = "";
      data.leaderboard.forEach((item, i) => {
        list.innerHTML += `<div class="rank-item ${i<3?'rank-top':''}"><span>NO.${i+1} - ${item.id}</span><span>${item.score}åˆ†</span></div>`;
      });
    }).catch(()=>document.getElementById('sync-status').innerText="âŒ ç¶²è·¯åŒæ­¥å¤±æ•—");
  }

  return {
    start: function() {
      if(!document.getElementById('pg-class').value || !document.getElementById('pg-seat').value) return alert('è«‹è¼¸å…¥ç­ç´šåº§è™Ÿ');
      initAudio(); score=0; time=60; playing=true; combo=0;
      document.getElementById('pg-login-view').style.display='none';
      document.getElementById('pg-game-view').style.display='block';
      speak("æŒ‘æˆ°é–‹å§‹"); generateQuestion();
      timer = setInterval(()=>{
        time--; document.getElementById('pg-timer').innerText=time; playTick(time);
        if(time>10 && time%10==0) speak("é‚„å‰©"+time+"ç§’");
        else if(time<=5 && time>0) speak(time);
        if(time<=0){
          clearInterval(timer); playing=false; speak("æŒ‘æˆ°çµæŸ");
          document.getElementById('pg-game-view').style.display='none';
          document.getElementById('pg-result-view').style.display='block';
          document.getElementById('pg-final-score-num').innerText=score;
          document.getElementById('pg-final-student-id').innerText = document.getElementById('pg-class').value + "ç­" + document.getElementById('pg-seat').value + "è™Ÿ";
          sendData();
        }
      }, 1000);
    }
  };
})();

// æ‚¨è¦æ±‚çš„å¿ƒè¡€ä¿è­·æªæ–½
(function() {
    document.addEventListener('contextmenu', e=>e.preventDefault());
    document.addEventListener('selectstart', e=>e.preventDefault());
    document.addEventListener('keydown', e=>{
        if(e.keyCode==123 || (e.ctrlKey && e.shiftKey && (e.keyCode==73||e.keyCode==74)) || (e.ctrlKey && (e.keyCode==85||e.keyCode==83))) e.preventDefault();
    });
})();
</script>
</body>
</html>
