<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>3-3 å¹´é½¡å•é¡Œå…¨å“¡ç«¶æŠ€å ´</title>
<style>
/* å®Œå…¨é‚„åŸæ‚¨æœ€æ„›çš„ç¶ è‰²ä¸»é¡Œæ¨£å¼ */
:root { --c-blue:#4dabf7; --c-bg:#e7f5ff; --c-text:#1971c2; --c-org:#ff922b; --c-org-bg:#fff4e6; --c-org-text:#d9480f; --c-alert:#e03131; }
body { margin: 0; padding: 0; background: var(--c-bg); font-family: 'Microsoft JhengHei', sans-serif; user-select: none; -webkit-user-select: none; }
#game-simplify { max-width:850px; margin:20px auto; padding:25px; border:5px solid #f1f3f5; border-radius:20px; text-align:center; background:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.08); position:relative; overflow:hidden; }
.pg-title { font-size:2.5rem; color:#ff0000; margin-bottom:20px; font-weight:900; text-shadow:2px 2px 4px rgba(0,0,0,0.1); }
.pg-input-group { display:flex; justify-content:center; gap:15px; margin-bottom:20px; }
.pg-input-wrap input { width:110px; font-size:2rem; text-align:center; padding:10px; border:3px solid #ddd; border-radius:12px; font-weight:bold; }
.pg-btn { border:none; padding:15px 40px; font-size:2rem; border-radius:15px; cursor:pointer; font-weight:bold; background:#5c7cfa; color:white; transition: 0.2s; }
.pg-btn:hover { background:#3b5bdb; }
.pg-header { display:flex; gap:10px; margin-bottom:20px; }
.pg-card { flex:1; background:var(--c-bg); padding:15px; border-radius:15px; border:2px solid var(--c-blue); font-weight:bold; }
.pg-card .val { font-size:3rem; line-height:1; display:block; margin-top:5px; }
#pg-problem-text { font-size: 1.8rem; font-weight: bold; margin: 25px 0; color: #333; line-height: 1.8; min-height: 80px; }
.pg-options-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
.pg-opt-btn { background:#fff; border:3px solid var(--c-blue); font-size:1.4rem; padding:15px; border-radius:15px; cursor:pointer; font-weight:bold; min-height: 80px; }
.pg-correct { background:#40c057!important; color:#fff!important; }
.pg-wrong { background:#fa5252!important; color:#fff!important; }
/* æ’è¡Œæ¦œè¦–çª— */
#rank-board { margin-top: 25px; text-align: left; background: #fff9db; border: 3px solid #fab005; border-radius: 15px; padding: 15px; display:none; }
.rank-scroll { max-height: 300px; overflow-y: auto; margin-top: 10px; }
.rank-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #ffe066; font-size: 1.2rem; }
.rank-top3 { font-weight: 900; color: #d9480f; background: #fff4e6; }
</style>
</head>
<body oncontextmenu="return false;">

<div id="game-simplify">
    <div id="pg-login-view">
        <h1 class="pg-title">3-3 ã€Œå¹´é½¡å•é¡Œã€å…¨å“¡ç«¶æŠ€å ´</h1>
        <div class="pg-input-group">
            <div class="pg-input-wrap"><input type="tel" id="pg-class" placeholder="ç­ç´š"></div>
            <div class="pg-input-wrap"><input type="tel" id="pg-seat" placeholder="åº§è™Ÿ"></div>
        </div>
        <button class="pg-btn" onclick="GameSimp.start()">é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <div id="pg-game-view" style="display:none;">
        <div class="pg-header">
            <div class="pg-card">å€’æ•¸<span class="val" id="pg-timer">60</span></div>
            <div class="pg-card">å¾—åˆ†<span class="val" id="pg-score">0</span></div>
        </div>
        <div id="pg-problem-text"></div>
        <div class="pg-options-grid" id="pg-options"></div>
    </div>

    <div id="pg-result-view" style="display:none;">
        <h1 class="pg-title">æŒ‘æˆ°çµæŸï¼</h1>
        <h2 id="pg-final-id"></h2>
        <div style="font-size:5rem; color:red; font-weight:bold; margin-bottom:10px;" id="pg-final-score">0</div>
        <p id="status-text">ğŸ† æ­£åœ¨è¨ˆç®—å…¨ç­æ’å...</p>
        
        <div id="rank-board">
            <h3 style="margin:0; color:#e67700;">ğŸŒŸ å…¨å“¡å³æ™‚è‹±é›„æ¦œ</h3>
            <div class="rank-scroll" id="rank-list"></div>
        </div>
        
        <button class="pg-btn" onclick="location.reload()" style="margin-top:20px;">å†æˆ°ä¸€å ´</button>
    </div>
</div>

<script>
// æ‚¨å°ˆå±¬çš„ API é€£æ¥ç¶²å€
const _0x_secret_url = "https://script.google.com/macros/s/AKfycbxBPnJo1I_P6mKlJ0ALJ9J0HwcoYaYSOdFgkgZAtpQ26OQblc5irWpKLDD4JITJdYbe/exec";

var GameSimp = (function() {
    var score=0, time=60, timer=null, playing=false, ans="", audioCtx=null;

    function speak(t){ window.speechSynthesis.cancel(); var u=new SpeechSynthesisUtterance(t); u.lang='zh-TW'; u.rate=1.4; window.speechSynthesis.speak(u); }
    function initAudio(){ if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)(); }
    function playBeep(f){ if(!audioCtx)return; var o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type='sine'; o.frequency.value=f; g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.5); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.5); }

    function generate() {
        var roles=[{b:"çˆ¶è¦ª",s:"å…’å­"},{b:"æ¯è¦ª",s:"å¥³å…’"},{b:"è€å¸«",s:"å­¸ç”Ÿ"}];
        var r=roles[Math.floor(Math.random()*roles.length)];
        var d=Math.floor(Math.random()*15+20), s=Math.floor(Math.random()*30+50);
        ans = `x + (x + ${d}) = ${s}`;
        document.getElementById('pg-problem-text').innerText = `${r.b}æ¯”${r.s}å¤§ ${d} æ­²ï¼Œå…©äººå¹´é½¡å’Œç‚º ${s} æ­²ã€‚è‹¥${r.s}ä»Šå¹´ x æ­²ï¼Œåˆ—å‡ºæ–¹ç¨‹å¼ã€‚`;
        var g=document.getElementById('pg-options'); g.innerHTML="";
        [`x + (x + ${d}) = ${s}`, `x + (x - ${d}) = ${s}`, `2x = ${s} + ${d}`, `x + x = ${s} - ${d}`].sort(()=>Math.random()-0.5).forEach(o=>{
            var b=document.createElement('button'); b.className='pg-opt-btn'; b.innerText=o; b.onclick=function(){check(o,b)}; g.appendChild(b);
        });
    }

    function check(v,b){
        if(!playing)return;
        if(v===ans){ score+=10; b.classList.add('pg-correct'); playBeep(523); }
        else { score-=5; b.classList.add('pg-wrong'); playBeep(150); }
        document.getElementById('pg-score').innerText=score;
        setTimeout(generate, 800);
    }

    function sendScore() {
        var payload = {
            classId: document.getElementById('pg-class').value,
            seatId: document.getElementById('pg-seat').value,
            score: score
        };
        fetch(_0x_secret_url, { method: "POST", body: JSON.stringify(payload) })
        .then(res => res.json())
        .then(data => {
            document.getElementById('status-text').innerText = "âœ… å·²åŒæ­¥å…¨ç­æ•¸æ“š";
            document.getElementById('rank-board').style.display = "block";
            var list = document.getElementById('rank-list'); list.innerHTML = "";
            data.leaderboard.forEach((item, i) => {
                var isTop = i < 3;
                list.innerHTML += `<div class="rank-item ${isTop?'rank-top3':''}">
                    <span>NO.${i+1} - ${item.id}</span>
                    <span>${item.score} åˆ†</span>
                </div>`;
            });
        }).catch(() => { document.getElementById('status-text').innerText = "âŒ ç¶²è·¯é€£ç·šä¸ç©©ï¼Œç„¡æ³•é¡¯ç¤ºæ’å"; });
    }

    return {
        start: function() {
            if(!document.getElementById('pg-class').value || !document.getElementById('pg-seat').value) return alert("è«‹è¼¸å…¥ç­ç´šèˆ‡åº§è™Ÿï¼");
            initAudio(); playing=true;
            document.getElementById('pg-login-view').style.display='none';
            document.getElementById('pg-game-view').style.display='block';
            speak("æŒ‘æˆ°é–‹å§‹"); generate();
            timer = setInterval(function(){
                time--; document.getElementById('pg-timer').innerText=time;
                if(time<=10 && time>0) speak(time);
                if(time<=0){
                    clearInterval(timer); playing=false;
                    document.getElementById('pg-game-view').style.display='none';
                    document.getElementById('pg-result-view').style.display='block';
                    document.getElementById('pg-final-score').innerText=score;
                    document.getElementById('pg-final-id').innerText = document.getElementById('pg-class').value + "ç­" + document.getElementById('pg-seat').value + "è™Ÿ";
                    speak("æ™‚é–“åˆ°ï¼ŒæŒ‘æˆ°çµæŸ"); sendScore();
                }
            }, 1000);
        }
    };
})();

// å¿ƒè¡€ä¿è­·æ©Ÿåˆ¶ï¼šç¦æ­¢å³éµã€é¸å–ã€F12
(function(){
    document.addEventListener('contextmenu', e=>e.preventDefault());
    document.addEventListener('selectstart', e=>e.preventDefault());
    document.addEventListener('keydown', e=>{
        if(e.keyCode==123 || (e.ctrlKey && (e.shiftKey && (e.keyCode==73||e.keyCode==74) || e.keyCode==85||e.keyCode==83))) e.preventDefault();
    });
})();
</script>
</body>
</html>
