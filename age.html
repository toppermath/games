<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>3-3 ã€Œå¹´é½¡å•é¡Œã€åˆ—å¼ æŒ‘æˆ°è³½</title>
<style>
/* CSS æ¨£å¼ */
:root { --c-blue:#4dabf7; --c-bg:#e7f5ff; --c-text:#1971c2; --c-org:#ff922b; --c-org-bg:#fff4e6; --c-org-text:#d9480f; --c-alert:#e03131; }
body { margin: 0; padding: 0; background: var(--c-bg); font-family: 'Microsoft JhengHei', sans-serif; user-select: none; -webkit-user-select: none; }
#game-simplify { max-width:850px; margin:20px auto; padding:30px; border:5px solid #f1f3f5; border-radius:20px; text-align:center; background:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.08); transition:border-color 0.1s, box-shadow 0.1s; position:relative; overflow:hidden; }
.pg-title { font-size:2.5rem; color:#ff0000; margin-bottom:30px; font-weight:900; text-shadow:2px 2px 4px rgba(0,0,0,0.15); line-height: 1.3; }
.pg-input-group { display:flex; justify-content:center; gap:20px; margin-bottom:30px; }
.pg-input-wrap label { display:block; font-size:1.5rem; margin-bottom:5px; font-weight:bold; color:#666; }
.pg-input-wrap input { width:130px; font-size:2.2rem; text-align:center; padding:10px; border:3px solid #ddd; border-radius:12px; font-weight:bold; color:#333; }
.pg-btn-start, .pg-btn-restart, .pg-btn-review { border:none; padding:15px 40px; font-size:2rem; border-radius:15px; cursor:pointer; font-family:'Microsoft JhengHei'; font-weight:bold; margin:10px; }
.pg-btn-start, .pg-btn-restart { background:#5c7cfa; color:white; }
.pg-btn-review { background:#fcc419; color:#d9480f; }
.pg-header { display:flex; gap:15px; margin-bottom:20px; position:relative; }
.pg-info-card { flex:1; background:var(--c-bg); color:var(--c-text); padding:15px; border-radius:15px; font-weight:bold; border:2px solid var(--c-blue); }
.pg-info-card .label { display:block; font-size:1.2rem; opacity:0.8; }
.pg-info-card .value { font-size:3.5rem; line-height:1.1; }
#pg-combo-box { position:absolute; right:-20px; top:-15px; background:#ffec99; border:4px solid #e67700; border-radius:50%; width:100px; height:100px; display:flex; flex-direction:column; justify-content:center; align-items:center; transform:rotate(15deg); box-shadow:0 5px 15px rgba(230,119,0,0.4); z-index:10; }
.combo-hide { display:none!important; }
.combo-label { font-size:1.2rem; font-weight:bold; color:#e67700; margin-bottom:-5px; }
.combo-val { font-size:3.5rem; font-weight:900; color:#d9480f; text-shadow:1px 1px 0 #fff; }
.combo-pump { animation:pump 0.2s; }
#turkey-overlay { position:absolute; top:15px; left:15px; width:auto; height:auto; background:transparent; z-index:999; display:flex; pointer-events:none; }
.turkey-hide { display:none!important; }
.turkey-content { display:flex; align-items:center; gap:10px; background:rgba(255,236,153,0.98); border:3px solid #e67700; border-radius:40px; padding:8px 25px; box-shadow:0 8px 15px rgba(0,0,0,0.2); animation:popInCorner 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.turkey-icon { font-size:3rem; line-height:1; animation:wobble 1s infinite; }
.turkey-info { text-align:left; }
.turkey-text { font-size:1.8rem; font-weight:900; color:#e03131; line-height:1; margin-bottom:2px; }
.turkey-sub { font-size:1.1rem; color:#d9480f; font-weight:bold; }
@keyframes popInCorner { from{transform:scale(0) translate(-50px,-50px);opacity:0} to{transform:scale(1) translate(0,0);opacity:1} }
@keyframes wobble { 0%,100%{transform:rotate(-10deg)} 50%{transform:rotate(10deg)} }
.pg-question-area { background:var(--c-org-bg); border:4px solid var(--c-org); padding:25px; border-radius:20px; margin-bottom:20px; }
.pg-question-text { font-size:1.5rem; margin:0; color:var(--c-org-text); text-align:left; }

/* --- é¡Œç›®æ–‡å­—ä¿®æ­£ï¼šå–æ¶ˆ Flexï¼Œè®“æ–‡å­—è‡ªç„¶æ›è¡Œ --- */
#pg-problem-text { 
    font-size: 1.8rem; 
    font-weight: bold; 
    margin: 20px 0 30px; 
    color: #333; 
    line-height: 1.8; 
    text-align: center; 
    padding: 0 10px; 
    min-height: 80px; 
    display: block; /* é—œéµä¿®æ­£ï¼šç¢ºä¿æ–‡å­—ä¸æœƒè¢«åˆ‡æ–· */
}

/* --- ğŸ”¥ åˆ†æ•¸å°ˆç”¨ CSS (ç›´å¼æ’åˆ—) --- */
.fraction {
    display: inline-block;
    vertical-align: middle;
    margin: 0 0.2rem;
    text-align: center;
    font-size: 0.9em; /* åˆ†æ•¸ç¨å¾®ç¸®å°ä¸€é»é»ä»¥é…åˆè¡Œé«˜ */
}
.fraction .top {
    display: block;
    border-bottom: 2px solid currentColor; /* è·Ÿéš¨æ–‡å­—é¡è‰² */
    padding: 0 2px;
    line-height: 1;
}
.fraction .bottom {
    display: block;
    padding: 0 2px;
    line-height: 1;
}

.pg-options-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
/* é¸é …èª¿æ•´ */
.pg-opt-btn { 
    background:#fff; border:3px solid var(--c-blue); color:var(--c-text); 
    font-size:1.4rem; /* é¸é …å­—é«”åŠ å¤§ */
    padding:15px 5px; border-radius:15px; cursor:pointer; font-weight:bold; 
    font-family:'Segoe UI', 'Microsoft JhengHei', sans-serif; 
    display:flex; justify-content:center; align-items:center; 
    min-height: 80px; line-height: 1.3; 
}
.pg-opt-btn:hover { background:#e7f5ff; }
.pg-correct { background:#40c057!important; color:#fff!important; border-color:#2b8a3e!important; }
.pg-wrong { background:#fa5252!important; color:#fff!important; border-color:#c92a2a!important; }
/* è®“æ­£ç¢ºéŒ¯èª¤æ™‚çš„åˆ†æ•¸ç·šè®Šè‰² */
.pg-correct .fraction .top { border-bottom-color: #fff; }
.pg-wrong .fraction .top { border-bottom-color: #fff; }

.pg-result-card { border:4px solid var(--c-blue); padding:30px 10px; border-radius:20px; background:#f8f9fa; margin-bottom:20px; }
#pg-final-student-id { font-size:4rem; font-weight:900; color:#333; margin-bottom:10px; border-bottom:2px dashed #ccc; padding-bottom:15px; display:inline-block; min-width:80%; }
.pg-final-label { font-size:1.5rem; color:#777; margin-top:15px; }
#pg-final-score-num { font-size:8rem; font-weight:900; color:var(--c-alert); line-height:1; margin:10px 0 30px 0; }
#pg-wrong-list-area { background:#fff5f5; border:2px dashed #ff8787; padding:20px; margin-top:20px; border-radius:10px; text-align:left; }
#pg-wrong-list-area h3 { color:#e03131; margin-top:0; font-size:1.5rem; display:inline-block; }
.copy-btn { background:#adb5bd; color:#fff; border:none; padding:5px 15px; border-radius:5px; cursor:pointer; font-size:1rem; }
.copy-btn:hover { background:#868e96; }
#pg-wrong-list { list-style:none; padding:0; margin:10px 0 0 0; }
#pg-wrong-list li { border-bottom:1px solid #ffd8a8; padding:15px 0; font-size:1.2rem; color:#333; position:relative; }
.tag-type { display:inline-block; background:#339af0; color:#fff; font-size:0.9rem; padding:2px 8px; border-radius:4px; margin-right:8px; vertical-align:text-bottom; }
.w-q { font-weight:bold; color:#495057; margin-bottom:8px; display:block; line-height:1.4; }
.w-a { color:#2b8a3e; display:block; font-weight:bold; margin-top:5px; }
.pg-history-board { text-align:left; padding:20px; background:#f1f3f5; border-radius:15px; }
.pg-history-board li { padding:10px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; font-size:1.2rem; }
.wrong-shake { animation:shake 0.4s; border-color:#fa5252!important; box-shadow:0 0 20px rgba(250,82,82,0.4)!important; }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-10px)} 75%{transform:translateX(10px)} }
@keyframes pump { 0%{transform:scale(1) rotate(15deg)} 50%{transform:scale(1.2) rotate(15deg)} 100%{transform:scale(1) rotate(15deg)} }
@media(max-width:768px){ .pg-title{font-size:1.8rem} #pg-problem-text{font-size:1.3rem} .pg-opt-btn{font-size:1.1rem} #pg-final-student-id{font-size:3rem} #pg-final-score-num{font-size:6rem} .pg-options-grid{grid-template-columns:1fr} #pg-combo-box{width:80px; height:80px; right:0px; top:-10px} .combo-val{font-size:2.5rem} }
</style>

<div id="game-simplify">
  <div id="pg-login-view">
    <h1 class="pg-title">3-3 ã€Œå¹´é½¡å•é¡Œã€åˆ—å¼æŒ‘æˆ°è³½</h1>
    <div class="pg-input-group">
      <div class="pg-input-wrap">
        <label>ç­ç´š</label>
        <input type="tel" id="pg-class" placeholder="701" maxlength="3" oninput="this.value=this.value.replace(/[^0-9]/g,'');">
      </div>
      <div class="pg-input-wrap">
        <label>åº§è™Ÿ</label>
        <input type="tel" id="pg-seat" placeholder="05" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'');">
      </div>
    </div>
    <button class="pg-btn-start" onclick="GameSimp.start()">é–‹å§‹æŒ‘æˆ°</button>
  </div>

  <div id="pg-game-view" style="display:none;">
    <div class="pg-header">
      <div class="pg-info-card blue-theme">
        <span class="label">å€’æ•¸</span>
        <span class="value" id="pg-timer">60</span>
      </div>
      <div class="pg-info-card blue-theme">
        <span class="label">å¾—åˆ†</span>
        <span class="value" id="pg-score">0</span>
      </div>
      <div id="pg-combo-box" class="combo-hide">
        <div class="combo-label">é€£æ“Š</div>
        <div class="combo-val" id="pg-combo-num">0</div>
      </div>
    </div>
    
    <div class="pg-question-area orange-theme">
      <h2 class="pg-question-text">ä¾é¡Œæ„åˆ—å‡ºæ–¹ç¨‹å¼ï¼š</h2>
      <div id="pg-problem-text"></div>
      <div class="pg-options-grid" id="pg-options"></div>
    </div>

    <div id="turkey-overlay" class="turkey-hide">
      <div class="turkey-content">
        <div class="turkey-icon">ğŸ¦ƒ</div> 
        <div class="turkey-info">
            <div class="turkey-text">å˜‰ç¾©ç«é›!</div>
            <div class="turkey-sub" id="turkey-msg">é€£å° 3 é¡Œ</div>
        </div>
      </div>
    </div>
  </div>

  <div id="pg-result-view" style="display:none;">
    <div class="pg-result-card">
      <h2 class="pg-result-title">æŒ‘æˆ°çµæœ</h2>
      <div id="pg-final-student-id"></div>
      <div class="pg-final-label">æœ€çµ‚å¾—åˆ†</div>
      <div id="pg-final-score-num">0</div>
      
      <div class="pg-btn-group">
        <button class="pg-btn-restart" onclick="GameSimp.reset()">ç¹¼çºŒæŒ‘æˆ°</button>
        <button class="pg-btn-review" onclick="GameSimp.toggleReview()" id="btn-review" style="display:none;">ğŸ“– æŸ¥çœ‹éŒ¯é¡Œç´€éŒ„</button>
      </div>
      
      <div id="pg-wrong-list-area" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>âš ï¸ éŒ¯é¡Œç´€éŒ„ (è«‹è¨‚æ­£)</h3>
            <button class="copy-btn" onclick="GameSimp.copyWrong()">ğŸ“‹ è¤‡è£½ç´€éŒ„</button>
        </div>
        <ul id="pg-wrong-list"></ul>
      </div>
    </div>
    <div class="pg-history-board">
      <h3>ğŸ† è§£é¡Œé«˜æ‰‹æ¦œ</h3>
      <ul id="pg-score-list"></ul>
    </div>
  </div>
</div>

<script>
var GameSimp = (function() {
  let score=0, time=60, timer=null, playing=false, ans="", currentQ="", currentTag="", audioCtx=null;
  let wrongLog = []; 
  let combo = 0; 

  function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  // --- ğŸ”¥ åˆ†æ•¸ç”¢ç”Ÿå™¨ Helper ---
  // è¼¸å‡º HTML çµæ§‹ï¼š<span class="fraction"><span class="top">åˆ†å­</span><span class="bottom">åˆ†æ¯</span></span>
  function getFrac(top, bottom) {
      return `<span class="fraction"><span class="top">${top}</span><span class="bottom">${bottom}</span></span>`;
  }

  // --- ğŸ”¥ 3-3 å¹´é½¡å•é¡Œ é¡Œåº« ---
  function generateQuestion() {
      const type = rand(0, 4); 
      let qObj = {};
      
      const roles = [
          {b:"çˆ¶è¦ª", s:"å…’å­"}, {b:"æ¯è¦ª", s:"å¥³å…’"}, {b:"çˆºçˆº", s:"å­«å­"}, {b:"è€å¸«", s:"å­¸ç”Ÿ"}
      ];
      let r = roles[rand(0, roles.length-1)];

      switch(type) {
          case 0: // åŸºç¤å’Œå·®
              let diff = rand(20, 40);
              let sum = rand(50, 90);
              qObj = {
                  t: "å¹´é½¡å’Œå·®",
                  q: `${r.b}æ¯”${r.s}å¤§ ${diff} æ­²ï¼Œå…©äººå¹´é½¡å’Œç‚º ${sum} æ­²ã€‚è‹¥${r.s}ä»Šå¹´ x æ­²ï¼Œåˆ—å‡ºæ–¹ç¨‹å¼ã€‚`,
                  a: `x + (x + ${diff}) = ${sum}`,
                  o: [
                      `x + (x + ${diff}) = ${sum}`,
                      `x + (x - ${diff}) = ${sum}`,
                      `x + x = ${sum} + ${diff}`,
                      `(x + ${diff}) - x = ${sum}`
                  ]
              };
              break;

          case 1: // åŸºç¤å€æ•¸ (åŒ…å«åˆ†æ•¸é¸é …)
              let times = rand(2, 4);
              let total = rand(40, 80);
              // æ­£è§£æ˜¯ä¹˜æ³•ï¼Œä½†å¹²æ“¾é¸é …æœƒæœ‰é™¤æ³•ï¼Œé€™æ™‚è¦ç”¨åˆ†æ•¸é¡¯ç¤º
              qObj = {
                  t: "å¹´é½¡å€æ•¸",
                  q: `${r.b}çš„å¹´é½¡æ˜¯${r.s}çš„ ${times} å€ï¼Œå…©äººå¹´é½¡å’Œç‚º ${total} æ­²ã€‚è‹¥${r.s}ä»Šå¹´ x æ­²ï¼Œåˆ—å‡ºæ–¹ç¨‹å¼ã€‚`,
                  a: `x + ${times}x = ${total}`,
                  o: [
                      `x + ${times}x = ${total}`,
                      `x + ${getFrac('x', times)} = ${total}`, // ä½¿ç”¨åˆ†æ•¸é¡¯ç¤º
                      `${times}x - x = ${total}`,
                      `x + (x + ${times}) = ${total}`
                  ]
              };
              break;

          case 2: // Nå¹´å¾Œå€æ•¸
              let fDiff = rand(20, 35);
              let fYear = rand(3, 10);
              let fTimes = rand(2, 3);
              qObj = {
                  t: "Nå¹´å¾Œå€æ•¸",
                  q: `${r.b}ä»Šå¹´ ${fDiff} æ­²ï¼Œ${r.s}ä»Šå¹´ x æ­²ã€‚<span style='color:#e03131;'>${fYear} å¹´å¾Œ</span>ï¼Œ${r.b}çš„å¹´é½¡æ˜¯${r.s}çš„ ${fTimes} å€ã€‚`,
                  a: `${fDiff} + ${fYear} = ${fTimes}(x + ${fYear})`,
                  o: [
                      `${fDiff} + ${fYear} = ${fTimes}(x + ${fYear})`,
                      `${fDiff} + ${fYear} = ${fTimes}x + ${fYear}`,
                      `${fDiff} = ${fTimes}(x + ${fYear})`,
                      `(${fDiff} + ${fYear}) * ${fTimes} = x + ${fYear}`
                  ]
              };
              break;

          case 3: // Nå¹´å‰å€æ•¸
              let pAge = rand(30, 50);
              let pYear = rand(2, 5);
              let pTimes = rand(3, 5);
              qObj = {
                  t: "Nå¹´å‰å€æ•¸",
                  q: `${r.b}ä»Šå¹´ ${pAge} æ­²ï¼Œ${r.s}ä»Šå¹´ x æ­²ã€‚<span style='color:#e03131;'>${pYear} å¹´å‰</span>ï¼Œ${r.b}çš„å¹´é½¡æ˜¯${r.s}çš„ ${pTimes} å€ã€‚`,
                  a: `${pAge} - ${pYear} = ${pTimes}(x - ${pYear})`,
                  o: [
                      `${pAge} - ${pYear} = ${pTimes}(x - ${pYear})`,
                      `${pAge} - ${pYear} = ${pTimes}x - ${pYear}`,
                      `${pAge} = ${pTimes}(x - ${pYear})`,
                      `${pAge} - ${pYear} = ${pTimes}x`
                  ]
              };
              break;
          
          case 4: // æ™‚æ…‹ç¸½å’Œ
              let curDiff = rand(25, 30);
              let futYear = rand(5, 10);
              let futSum = rand(80, 120);
              qObj = {
                  t: "æ™‚æ…‹ç¸½å’Œ",
                  q: `${r.b}æ¯”${r.s}å¤§ ${curDiff} æ­²ï¼Œè‹¥${r.s}ä»Šå¹´ x æ­²ã€‚<span style='color:#e03131;'>${futYear} å¹´å¾Œ</span>ï¼Œå…©äººçš„å¹´é½¡å’Œç‚º ${futSum} æ­²ã€‚`,
                  a: `(x + ${futYear}) + (x + ${curDiff} + ${futYear}) = ${futSum}`,
                  o: [
                      `(x + ${futYear}) + (x + ${curDiff} + ${futYear}) = ${futSum}`,
                      `x + (x + ${curDiff}) + ${futYear} = ${futSum}`,
                      `2x + ${curDiff} = ${futSum}`,
                      `(x - ${futYear}) + (x + ${curDiff} - ${futYear}) = ${futSum}`
                  ]
              };
              break;
      }
      
      let correctAns = qObj.a;
      let shuffledOpts = [...qObj.o].sort(() => Math.random() - 0.5);
      
      return {
          q: qObj.q,
          a: correctAns,
          o: shuffledOpts,
          t: qObj.t
      };
  }

  function initAudio(){ if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
  
  function playDingDong() { if(!audioCtx) return; const now=audioCtx.currentTime; let o1=audioCtx.createOscillator(),g1=audioCtx.createGain(); o1.type='sine'; o1.frequency.setValueAtTime(523.25,now); g1.gain.setValueAtTime(1.0,now); g1.gain.exponentialRampToValueAtTime(0.01,now+0.5); o1.connect(g1); g1.connect(audioCtx.destination); o1.start(now); o1.stop(now+0.5); if(combo>=2){ let o2=audioCtx.createOscillator(),g2=audioCtx.createGain(); o2.type='sine'; o2.frequency.setValueAtTime(783.99+(combo*50),now); g2.gain.setValueAtTime(0.8,now+0.1); g2.gain.exponentialRampToValueAtTime(0.01,now+0.6); o2.connect(g2); g2.connect(audioCtx.destination); o2.start(now+0.1); o2.stop(now+0.6); } }
  
  function playTurkeySound() {
    if(!audioCtx) return; const now = audioCtx.currentTime;
    let o1 = audioCtx.createOscillator(); let g1 = audioCtx.createGain();
    o1.type = 'sawtooth'; o1.frequency.setValueAtTime(200, now);
    for(let i=0; i<10; i++){
        o1.frequency.linearRampToValueAtTime(350, now + i*0.08);
        o1.frequency.linearRampToValueAtTime(200, now + i*0.08 + 0.04);
    }
    g1.gain.setValueAtTime(1.0, now); g1.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
    o1.connect(g1); g1.connect(audioCtx.destination); o1.start(now); o1.stop(now + 0.8);
    let o2 = audioCtx.createOscillator(); let g2 = audioCtx.createGain();
    o2.type = 'square'; o2.frequency.setValueAtTime(400, now);
    for(let i=0; i<10; i++){
        o2.frequency.linearRampToValueAtTime(500, now + i*0.08);
        o2.frequency.linearRampToValueAtTime(400, now + i*0.08 + 0.04);
    }
    g2.gain.setValueAtTime(0.6, now); g2.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
    o2.connect(g2); g2.connect(audioCtx.destination); o2.start(now); o2.stop(now + 0.8);
  }
  
  function tone(f,t,d){ 
    if(!audioCtx)return; 
    let o=audioCtx.createOscillator(),g=audioCtx.createGain(); 
    o.type='sawtooth'; o.frequency.value=f; g.gain.value=1.0; 
    o.connect(g); g.connect(audioCtx.destination); 
    o.start(); o.stop(audioCtx.currentTime+d); 
  }
  
  function playTickSound(timeLeft) {
    if(!audioCtx) return; const now = audioCtx.currentTime;
    let o = audioCtx.createOscillator();
    let g = audioCtx.createGain();
    o.type = 'sine';
    let baseFreq = (timeLeft <= 10) ? 800 + (10-timeLeft)*100 : 600; 
    o.frequency.setValueAtTime(baseFreq, now);
    let vol = (timeLeft <= 10) ? 0.5 : 0.2;
    g.gain.setValueAtTime(vol, now);
    g.gain.exponentialRampToValueAtTime(0.01, now + 0.1); 
    o.connect(g); g.connect(audioCtx.destination);
    o.start(now); o.stop(now + 0.1);
  }
  
  function speak(txt){ 
    window.speechSynthesis.cancel(); 
    let u=new SpeechSynthesisUtterance(txt); 
    u.lang='zh-TW'; 
    u.rate = 1.4; 
    u.pitch = 1.6; 
    u.volume = 1.0; 
    window.speechSynthesis.speak(u); 
  }
  
  function next() {
    if(!playing)return;
    let p = generateQuestion();
    
    ans=p.a; currentQ=p.q; currentTag=p.t;
    document.getElementById('pg-problem-text').innerHTML = p.q; 
    let div = document.getElementById('pg-options'); div.innerHTML="";
    p.o.forEach(o=>{ 
        let b=document.createElement('button'); 
        b.className='pg-opt-btn'; 
        b.innerHTML=o; // æ”¹ç”¨ innerHTML ä»¥æ”¯æ´åˆ†æ•¸ HTML æ¨™ç±¤
        b.onclick=(e)=>check(o,e.currentTarget); 
        div.appendChild(b); 
    });
  }

  function showTurkey() {
    let el = document.getElementById('turkey-overlay');
    document.getElementById('turkey-msg').innerText = `é€£å° ${combo} é¡Œå¤ªå¼·å•¦`;
    el.classList.remove('turkey-hide');
    let content = el.querySelector('.turkey-content'); content.style.animation = 'none'; content.offsetHeight; content.style.animation = null; 
    playTurkeySound(); 
    setTimeout(() => { el.classList.add('turkey-hide'); }, 1500);
  }

  function check(v,btn) {
    if(!playing || btn.disabled) return;
    document.querySelectorAll('.pg-opt-btn').forEach(b=>b.disabled=true);
    if(v === ans){ 
        combo++; score+=10; btn.classList.add('pg-correct'); playDingDong(); updateComboUI();
        if(combo > 0 && combo % 3 === 0) { showTurkey(); }
    } else { 
        combo=0; score-=10; btn.classList.add('pg-wrong'); tone(150,'sawtooth',0.5); 
        // ç´€éŒ„éŒ¯é¡Œ (ç§»é™¤HTMLæ¨™ç±¤ä»¥ä¿æŒç´€éŒ„ä¹¾æ·¨)
        let cleanQ = currentQ.replace(/<[^>]*>/g, "");
        let cleanA = ans.replace(/<span class="fraction"><span class="top">/g, "").replace(/<\/span><span class="bottom">/g, "/").replace(/<\/span><\/span>/g, "");
        wrongLog.push({ q: cleanQ, a: cleanA, t: currentTag });
        
        let gameDiv = document.getElementById('game-simplify'); gameDiv.classList.remove('wrong-shake'); void gameDiv.offsetWidth; gameDiv.classList.add('wrong-shake');
        updateComboUI(); 
        // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
        document.querySelectorAll('.pg-opt-btn').forEach(b=>{ if(b.innerHTML === ans) b.classList.add('pg-correct'); }); 
    }
    document.getElementById('pg-score').innerText=score; setTimeout(next, 1200); 
  }
  
  function updateComboUI() {
      let box = document.getElementById('pg-combo-box'); let num = document.getElementById('pg-combo-num');
      if(combo >= 2) { box.classList.remove('combo-hide'); box.classList.remove('combo-pump'); void box.offsetWidth; box.classList.add('combo-pump'); num.innerText = combo; } 
      else { box.classList.add('combo-hide'); }
  }

  function tick() {
    time--; document.getElementById('pg-timer').innerText=time;
    playTickSound(time);
    if(time>10){ if(time%10==0) speak("é‚„å‰©"+time+"ç§’"); } 
    else if(time>0){ if(time <= 5) speak(time); }
    else end();
  }

  function end() {
    clearInterval(timer); playing=false;
    document.getElementById('pg-game-view').style.display='none';
    document.getElementById('pg-result-view').style.display='block';
    let cls = document.getElementById('pg-class').value; let seat = document.getElementById('pg-seat').value;
    document.getElementById('pg-final-student-id').innerText = cls + " ç­ " + seat + " è™Ÿ";
    document.getElementById('pg-final-score-num').innerText = score;
    
    if(wrongLog.length > 0) {
        document.getElementById('btn-review').style.display = "inline-block";
        let ul = document.getElementById('pg-wrong-list'); ul.innerHTML = "";
        wrongLog.forEach((item, index) => {
            ul.innerHTML += `<li>
              <span class="w-q"><span class="tag-type">${item.t}</span>${item.q}</span>
              <span class="w-a">æ­£è§£ï¼š${item.a}</span>
            </li>`;
        });
    } else { document.getElementById('btn-review').style.display = "none"; }
    speak("æ™‚é–“åˆ° æŒ‘æˆ°çµæŸ"); save();
  }
  
  function save(){
    let id = document.getElementById('pg-class').value + "-" + document.getElementById('pg-seat').value;
    // æ›´æ–° key
    let h = JSON.parse(localStorage.getItem('turkey_3_3_age')||'[]'); h.push({id:id, s:score}); h.sort((a,b)=>b.s-a.s);
    localStorage.setItem('turkey_3_3_age', JSON.stringify(h.slice(0,20)));
    let ul = document.getElementById('pg-score-list'); ul.innerHTML="";
    h.forEach((x,i)=>{ ul.innerHTML += `<li><span>#${i+1} ${x.id}</span><span>${x.s}åˆ†</span></li>`; });
  }

  return {
    start: function(){
       if(!document.getElementById('pg-class').value || !document.getElementById('pg-seat').value) return alert('è«‹è¼¸å…¥ç­ç´šåº§è™Ÿ');
       initAudio(); score=0; time=60; playing=true; wrongLog = []; combo = 0; updateComboUI(); 
       document.getElementById('pg-wrong-list-area').style.display = 'none'; 
       document.getElementById('pg-login-view').style.display='none';
       document.getElementById('pg-result-view').style.display='none';
       document.getElementById('pg-game-view').style.display='block';
       document.getElementById('pg-score').innerText=0;
       speak("æŒ‘æˆ°é–‹å§‹"); next(); timer = setInterval(tick, 1000);
    },
    reset: function(){ document.getElementById('pg-result-view').style.display='none'; document.getElementById('pg-login-view').style.display='block'; },
    toggleReview: function() { let area = document.getElementById('pg-wrong-list-area'); if(area.style.display === 'none') { area.style.display = 'block'; window.scrollTo(0, document.body.scrollHeight); } else { area.style.display = 'none'; } },
    copyWrong: function() {
        if(wrongLog.length === 0) return;
        let text = "ã€éŒ¯é¡Œç´€éŒ„ã€‘\n";
        wrongLog.forEach((w,i) => {
            text += `${i+1}. [${w.t}] ${w.q} \n   æ­£è§£ï¼š${w.a}\n`;
        });
        navigator.clipboard.writeText(text).then(() => { alert("å·²è¤‡è£½ï¼"); });
    }
  };
})();

(function() {
    document.addEventListener('contextmenu', function(e) { e.preventDefault(); });
    document.addEventListener('selectstart', function(e) { e.preventDefault(); });
    document.addEventListener('keydown', function(e) {
        if (e.keyCode == 123) { e.preventDefault(); return false; }
        if (e.ctrlKey && (e.keyCode == 85 || e.keyCode == 83 || e.keyCode == 80)) { e.preventDefault(); return false; }
        if (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74 || e.keyCode == 67)) { e.preventDefault(); return false; }
        if (e.ctrlKey && e.keyCode == 67) { e.preventDefault(); return false; }
    });
})();
</script>
</body>
</html>
